@model SNS.Apps.KPC.Libs.Models.UserRouteResult
@using SNS.Apps.KPC.Libs.Models
@using SNS.Apps.KPC.Libs.Utils
@using SNS.Apps.KPC.Libs.Configurations

@{
    Layout = "~/Views/Shared/_LayoutList.cshtml";
    String start_date = null;
    switch (Model.Route.RouteType)
    {
        case RouteType.Citywide_Workday:
            start_date = Model.Route.StartDate.Value.ToString("工作日 HH:mm");
            break;
        case RouteType.Citywide_Weekend:
            start_date = Model.Route.StartDate.Value.ToString("周末 HH:mm");
            break;
        case RouteType.Citywide_Temp:
            start_date = Model.Route.StartDate.Value.ToString("MM月dd日 HH:mm");
            break;
        case RouteType.Citywide_EveryDay:
            start_date = Model.Route.StartDate.Value.ToString("每天 HH:mm");
            break;
        case RouteType.Intercity_Workday:
            start_date = "工作日 有效";
            break;
        case RouteType.Intercity_Weekend:
            start_date = "周末 有效";
            break;
        case RouteType.Intercity_Temp:
            start_date = Model.Route.StartDate.Value.ToString("MM月dd日");
            break;
        case RouteType.Intercity_EveryDay:
            start_date = "长期有效";
            break;
        default:
            break;
    }
    if (HttpContext.Current.Request.UserAgent.Contains("kuaipinche"))
    {
        ViewBag.Title = "路线详情";
    }
    else
    {
        ViewBag.Title = "快拼车:" + (String.IsNullOrEmpty(Model.Route.From_Location) ? Model.Route.From_City : Model.Route.From_City + Model.Route.From_District) + (Model.Route.From_City == Model.Route.To_City ? Model.Route.From_Location : null) + "→" +
            (String.IsNullOrEmpty(Model.Route.To_Location) ? Model.Route.To_City : Model.Route.To_City + Model.Route.To_District) + (Model.Route.From_City == Model.Route.To_City ? Model.Route.To_Location : null) + "  " + start_date;
    }
    ViewBag.CurrentPageUrl = HttpUtility.UrlEncode(HttpContext.Current.Request.Url.AbsolutePath);
}

@section head{
    @Styles.Render("~/Content/route/view")
    <style>
        #wrapper {
            top: 0px;
        }

        .classPhone {
            position: fixed;
            bottom: 0px;
            left: 0px;
            right: 0px;
            line-height: 30px;
        }

        .showPortrait {
            width: 50px;
            height: 50px;
            vertical-align: middle;
        }

        button, button:visited {
            background-color: #2f8d13;
            border: 1px solid #008001;
            box-shadow: rgba(255, 255, 255, 0.298039) 0px 1px 0px 0px inset, rgb(204, 204, 204) 1px 1px 4px 0px;
            /*
            background: -webkit-gradient(linear, 0% 0, 0% 100%, from(#0faf0f), to(#008001));
                */
        }

            button:active {
                /*
                background: -webkit-gradient(linear, 0% 0, 0% 100%, from(#005801), to(#008001));
                    */
            }

        .phone {
            background: url(/content/images/phone.png) 10px no-repeat;
            background-size: 16px;
            text-indent: 35px;
            line-height: 50px;
            height: 50px;
            border-top: 1px dashed #aaa;
        }

        body {
            color: rgb(51,51,51);
            background-color: #fafafa;
        }

        .arrow {
            background-repeat: no-repeat;
            background-position: center;
            float: right;
            background-size: 20px 12px;
            width: 50px;
            height: 50px;
        }

        .share {
            font-size: 16px;
            padding: 8px 15px;
            color: #000000;
            background-color: #ffffff;
            background-image: linear-gradient(to top, #f5f5f5,#ffffff);
            box-shadow: 0 1px 2px 0 rgba(0,0,0,0.15);
            text-shadow: 0.5px 0.5px 1px #fff;
            border-radius: 3px;
            text-indent: 20px;
            border: 1px solid #d3d3d3;
        }
    </style>
}

<div>
    <div class="header" style="@(HttpContext.Current.Request.UserAgent.Contains("kuaipinche") ?"display:none":"")">
        <script>
            var message = location.hash.indexOf("#flag") === -1 ? false : true;
            var refernull = null;
            // #flag 处理返回按钮
            // #1 处理超时
        </script>
        @{
            ViewBag.ShowBackIcon = (HttpContext.Current.Request.UrlReferrer == null ? false : true);
        }

        <span id="backbtn" class="backbtn">
        </span>
        @if (!ViewBag.ShowBackIcon)
        {
            <script>
                refernull = true;
            </script>
        }
        <div class="headertitle">路线详情</div>
    </div><!-- navbar -->
    <div>
        @using (Html.BeginForm("Create", "Order", new { id = Model.Route.RouteGUID }, FormMethod.Get))
        {
            <div id="ul_info" style="padding:15px 10px 15px;background-color:#fafafa;">
                <div style="margin-bottom:15px;background-color:white;box-shadow:0 1px 3px rgba(0,0,0,0.3);">
                    <table style="width:100%;" cellpadding="0" cellspacing="0">
                        <tr>
                            <td style="width:50px;">
                                <a href="@Model.User.PortraitsUrl">
                                    <img class="showPortrait" src="@(!string.IsNullOrEmpty(Model.User.PortraitsThumbUrl) ? Model.User.PortraitsThumbUrl : ConfigStore.CommonSettings.Portraits_ImageDefault)" />
                                </a>
                            </td>
                            <td>
                                <a onclick="if (!refernull) showWait();" style="display:block;text-decoration:none;color:rgb(51,51,51);padding-left:5px;background:url(/content/images/rightarrow.png) 97% no-repeat;" href="/user/viewprofile/@Model.User.UserGUID">
                                    @((!string.IsNullOrEmpty(Model.User.NickName) && Model.User.NickName.Length > 6) ? Model.User.NickName.Substring(0, 6) : Model.User.NickName)
                                    <span style="display:inline-block;text-indent:12px;">@(Model.UserRole.GetDescription())</span>
                                </a>
                            </td>
                        </tr>
                    </table>
                    @if (HttpContext.Current.User.Identity.IsAuthenticated && ViewBag.IsRegisterted && !string.IsNullOrEmpty(Model.User.Mobile))
                    {
                        @*<div id="phoneNumberRegion" onclick="window.location.replace('tel:@Model.User.Mobile')" class="phone">
                                <a href="javascript:;" style="color:rgb(51,51,51);text-decoration:none;">@Model.User.Mobile</a>
                            </div>*@

                        { ViewBag.UserID = @Model.User.UserGUID.ToString(); }
                        <div id="phoneNumberRegion" class="phone">
                            @Html.Partial("_Partial_MixedMobile")
                        </div>
                    }
                    else if (!string.IsNullOrEmpty(Model.User.Mobile))
                    {
                        <a class="phone" onclick="if (!refernull) showWait();" href="/user/login?returnurl=/user/signin?returnurl=/route/view/@Model.Route.RouteGUID" style="color:rgb(51,51,51);display:block;text-decoration:none;">
                            点击后显示电话号码
                        </a>
                    }
                </div>
                <table width="100%" style="/*background: gainsboro;*/ background-color:white; box-shadow: 0 1px 3px rgba(0,0,0,0.3); " cellspacing="0">
                    <tr style="text-align:center;">
                        <td width="38%">
                            <span style="line-height:25px; font-weight:bold;">@(Model.Route.From_Location == null ? Model.Route.From_City : Model.Route.From_City + Model.Route.From_District)</span>
                            <div style="line-height: 25px; font-size: 14px;">
                                @Model.Route.From_Location
                            </div>
                        </td>
                        <td width="24%" style="font-size: 13px;color: #797979;">
                            @switch (Model.Route.RouteType)
                            {
                                case RouteType.Citywide_Workday:
                                    @(Model.Route.StartDate.Value.ToString("工作日 HH:mm"));
                                    break;
                                case RouteType.Citywide_Weekend:
                                @(Model.Route.StartDate.Value.ToString("周末 HH:mm"));
                                break;
                                case RouteType.Citywide_Temp:
                                @(Model.Route.StartDate.Value.ToString("MM月dd日 HH:mm"));
                                break;
                                case RouteType.Citywide_EveryDay:
                                @(Model.Route.StartDate.Value.ToString("每天 HH:mm"));
                                break;
                                case RouteType.Intercity_Workday:
                                @("工作日 有效");
                                break;
                                case RouteType.Intercity_Weekend:
                                @("周末 有效");
                                break;
                                case RouteType.Intercity_Temp:
                                @(Model.Route.StartDate.Value.ToString("MM月dd日"));
                                break;
                                case RouteType.Intercity_EveryDay:
                                @("长期有效");
                                break;
                                default:
                                break;
                            }
                        </td>
                        <td width="38%">
                            <span style="line-height:25px; font-weight:bold;">
                                @(Model.Route.To_Location == null ? Model.Route.To_City : Model.Route.To_City + Model.Route.To_District)
                            </span>
                            <div style="line-height: 25px; font-size: 14px;">
                                @Model.Route.To_Location
                            </div>
                        </td>
                    </tr>
                </table>
                @if (Model.UserRole == UserRole.Driver)
                {
                    <p>
                        <span style="color:rgb(153,153,153);">费用：</span>@(Model.Route.Charge.HasValue ? Model.Route.Charge.Value.ToString("N0") + " 元/人" : "面议")
                        @if (Model.Route.SeatCount.HasValue)
                        {
                            <span style="float:right;">
                                <span style="color:rgb(153,153,153);">座位：</span>
                                @Model.Route.SeatCount.Value
                                座
                            </span>
                        }
                    </p>
                }
                <p><span style="color:rgb(153,153,153);">备注：</span>@(Model.Route.Note == null ? "联系我时，请说是在微信\"快拼车\"上看到的，谢谢！" : Model.Route.Note + ";联系我时,请说是在微信\"快拼车\"上看到的,谢谢！")</p>

                @if (!ViewBag.IsRouteOwner)
                {
                    <div style="margin-top:15px;text-align:center">
                        <button id="btn_ok" onclick="if (!refernull) showWait();" style="border-radius:3px; font-size: 20px; /*background-color: #009900;*/ width: 100%; height: 50px; color: white; text-align: center;">@(Model.UserRole == UserRole.Driver ? "我是乘客，我要搭车" : "我是车主，我要载他")</button>
                    </div>
                }
            </div>
        }
        <div id="maptitle" style="background-color:#fafafa;padding:0px 0px 0px 10px;height:50px;line-height:50px;border-bottom:1px dashed #aaa;box-shadow:0px 1px 3px rgba(0,0,0,0.3);">
            <img src="/content/images/location.png" width="15" height="20" style="margin-bottom:5px;" valign="middle" />
            查看地图
            <span id="downarrow" class="arrow" style="display:block; background-image: url(/content/images/downarrow.png);"></span>
            <span id="uparrow" class="arrow" style="display:none;background-image:url(/content/images/uparrow.png);"></span>
        </div>
        <div id="map_canvas" style="display:none;width:100%;height:100%;min-height:150px;"></div><!-- /map -->
        @if (ViewBag.IsWeChatBrowser)
        {
            <table style="table-layout:fixed;width:100%;margin:15px 0px 0px;background-color:#fafafa;text-align:center;">
                <tr>
                    <td>
                        <input onclick="document.getElementById('mcover').style.display = 'block';" type="button" style="flex:1;background:url(/content/images/icon_msg.png) 5px 50% no-repeat;background-size:22px 22px;" class="share" value="发送给朋友" />
                    </td>
                    <td>
                        <input onclick="document.getElementById('mcover').style.display = 'block';" type="button" style="flex:1;background:url(/content/images/icon_timeline.png) 5px 50% no-repeat;background-size:22px 22px;" class="share" value="分享到朋友圈" />
                    </td>
                </tr>
            </table>
        }

        <div onclick="this.style.display = 'none';" id="mcover" style="display:none;z-index:1000;width:100%;height:100%;position:fixed;left:0;top:0;background:rgba(0,0,0,0.7);">
            <img src="/content/images/guide.png" style="position:fixed;top:5px;right:0px;" width="260" height="180" />
        </div>
        <!--
        <div style="position: absolute; margin-left:0px; bottom: 0; width: 100%; height: 1em; background-color: white; opacity: 0; filter: alpha(opacity=100); z-index: 10;"></div>
        -->
        @*@if (HttpContext.Current.User.Identity.IsAuthenticated && ViewBag.IsRegisterted && !string.IsNullOrEmpty(Model.User.Mobile))
            {
                <div id="phoneNumberRegion" onclick="window.location.replace('tel:@Model.User.Mobile')" class="classPhone" style="color:#ffcc00;opacity:1;padding-bottom:15px;padding-top:15px;background-color:#000;text-align:center;opacity:0.8">
                    <b style="font-size:15px;font-weight:bold;">点击拨打电话:</b>
                    <a href="javascript:;" style="color:#ffcc00; font-size:20px; text-decoration:none;font-weight:bold;">@Model.User.Mobile</a>
                </div>
            }
            else if (!string.IsNullOrEmpty(Model.User.Mobile))
            {
                <div id="phoneNumberRegion" class="classPhone" style="color:#ffcc00;opacity:1;padding-bottom:15px;padding-top:15px;background-color:#000;text-align:center;opacity:0.8">
                    <a href="/user/login?returnurl=/route/view/@Model.Route.RouteGUID" style="color:#ffcc00; font-size:15px; text-decoration:none;font-weight:bold;">点击"登录"后显示电话号码</a>
                </div>
            }*@
        @RenderPage("/Views/Shared/_Footer.cshtml")
    </div>

</div>

<!-- /script -->
@*<script type="text/javascript" src="@(string.Format(ConfigStore.MapAPISettings.Baidu_Map_URI, ConfigStore.MapAPISettings.MapAPIKey))"></script>*@
<script src="/Scripts/view/baidu.js"></script>

<script>
    var KPC = KPC || {};
    KPC.Peek = {};
    KPC.Peek.route_self = (function () {
        var route_frompoint = {
            lng: parseFloat("@ViewBag.FromPoint.Longitude"),
            lat: parseFloat("@ViewBag.FromPoint.Latitude")
        },
        route_topoint = {
            lng: parseFloat("@ViewBag.ToPoint.Longitude"),
            lat: parseFloat("@ViewBag.ToPoint.Latitude")
        };

        return {
            frompoint: route_frompoint,
            topoint: route_topoint
        };
    })();

    KPC.Peek.route_fellow = (function () {
        var route_frompoint = {
            lng: "@Model.Route.From_Point.Longitude",
            lat: "@Model.Route.From_Point.Latitude"
        },
        route_topoint = {
            lng: "@Model.Route.To_Point.Longitude",
            lat: "@Model.Route.To_Point.Latitude"
        };

        return {
            frompoint: route_frompoint,
            topoint: route_topoint
        };
    })();
</script>
@Scripts.Render("~/bundles/route/view")