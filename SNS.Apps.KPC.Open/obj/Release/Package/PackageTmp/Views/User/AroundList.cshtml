@model IEnumerable<SNS.Apps.KPC.Libs.Models.UserTrackResult>
@using SNS.Apps.KPC.Libs.Models
@using SNS.Apps.KPC.Libs.Configurations

@{
    Layout = "~/Views/Shared/_LayoutList.cshtml";
    ViewBag.Title = "快拼车";
}
@section head{
    @Styles.Render("~/Content/route/listview")
    <style>
        #navaroundlist {
            position: absolute;
            width: 80px;
            line-height: 45px;
            right: 80px;
            top: 40px;
            color: white;
        }

            #navaroundlist a {
                color: white;
                text-align: center;
            }

        .navtoggle {
            display: none;
        }

        .showPortrait {
            width: 50px;
            height: 50px;
            vertical-align: middle;
        }

        .rightarrow {
            width: 0px;
            height: 0px;
            line-height: 40px;
            right: 90px;
            position: absolute;
            text-align: center;
            color: white;
            border: 5px solid white;
            border-left-color: rgba(0,0,0,0);
            border-right-color: rgba(0,0,0,0);
            border-bottom-color: rgba(0,0,0,0);
            top: 50%;
        }

        #searchresult li:nth-child(2n+1) {
            background-color: white;
        }

        .ntchild {
            background-color: green;
            opacity: 0.9;
            filter: alpha(opacity=90);
            display: block;
        }

        ul#searchresult li a {
            padding: 0px;
        }
    </style>
    <script>
        var IsShowWait = false;
        if (location.hash.indexOf('#w') === -1) {
            // 不是从微信消息进来的
            IsShowWait = true;
        }
    </script>

}

@RenderPage("/Views/Shared/_Navbar.cshtml")

<div id="wrapper">
    <div class="header">
        <span id="navbar" class="headermenu"></span>
        <a onclick="if (IsShowWait) { showWait(); } else { WeixinJSBridge.call('closeWindow');} location.href='/user/around';" style="position:absolute;color: white; text-decoration: none; cursor: pointer;right: 10px">地图模式</a>
        <span style="position: absolute;text-align:center; right: 80px; width: 80px;" id="category">全部</span>
        <div class="rightarrow"></div>
        <div id="navaroundlist" class="navtoggle" onclick="nav(this);">
            <a href="javascript:;" class="ntchild" data-value="all">全部</a>
            <a href="javascript:;" class="ntchild" data-value="driver">车主</a>
            <a href="javascript:;" class="ntchild" data-value="passenger">乘客</a>
        </div>
    </div>
    <ul id="searchresult">
        @foreach (var item in Model)
        {
            <li>
                <a onclick="if (IsShowWait) showWait();" href="/user/viewprofile/@item.User.UserGUID@(HttpContext.Current.Request.UrlReferrer == null ? "#flag" : "")" style="display:block">
                    <table style="width:100%;">
                        <tr>
                            <td style="width:50px;">
                                <img class="showPortrait" src="@(!string.IsNullOrEmpty(item.User.PortraitsThumbUrl) ? item.User.PortraitsThumbUrl : ConfigStore.CommonSettings.Portraits_ImageDefault)" />
                                <span style="font-size:14px;margin-right:5px;vertical-align:middle;display:block;text-align:center;">@(item.User.UserRole == UserRole.Passenger ? "乘客" : "车主")</span>
                            </td>
                            <td>
                                <table width="100%" style="table-layout:fixed;">
                                    <tr style="height:28px;color:gray;font-size:14px;line-height:28px;">
                                        <td style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                            <span style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;width:50px;vertical-align:middle;">@item.User.NickName</span>
                                            
                                            <span style="vertical-align:middle;">@(item.Distance < 1 ? Convert.ToInt32(item.Distance * 1000) + "m" : item.Distance.Value.ToString().Substring(0, item.Distance.Value.ToString().IndexOf('.') + 2) + "km")</span>
                                        </td>
                                        <td style="text-align:right;">
                                            @if (item.Route != null)
                                            {
                                                switch (item.Route.RouteType)
                                                {
                                                    case RouteType.Citywide_Workday:
                                                        @(item.Route.StartDate.Value.ToString("工作日 HH:mm 出发"));
                                                        break;
                                                    case RouteType.Citywide_Weekend:
                                                    @(item.Route.StartDate.Value.ToString("周末 HH:mm 出发"));
                                                    break;
                                                    case RouteType.Citywide_Temp:
                                                    @(item.Route.StartDate.Value.ToString("MM月dd日 HH:mm 出发"));
                                                    break;
                                                    case RouteType.Citywide_EveryDay:
                                                    @(item.Route.StartDate.Value.ToString("每天 HH:mm 出发"));
                                                    break;
                                                    case RouteType.Intercity_Workday:
                                                    @("工作日 有效");
                                                    break;
                                                    case RouteType.Intercity_Weekend:
                                                    @("周末 有效");
                                                    break;
                                                    case RouteType.Intercity_Temp:
                                                    @(item.Route.StartDate.Value.ToString("MM月dd日 出发"));
                                                    break;
                                                    case RouteType.Intercity_EveryDay:
                                                    @("长期有效");
                                                    break;
                                                    default:
                                                    break;
                                                }
                                            }
                                        </td>
                                    </tr>
                                </table>
                                @if (item.Route != null)
                                {
                                    <p style="height:28px;line-height:28px;">
                                        <span style="float: left; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;width:50%;">@(item.Route.From_City == item.Route.To_City ? item.Route.From_District + item.Route.From_Location : item.Route.From_City + item.Route.From_Location)</span>
                                        <span style="float: right;text-align:right; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;width:50%;">@(item.Route.From_City == item.Route.To_City ? item.Route.To_District + item.Route.To_Location : item.Route.To_City + item.Route.To_Location)</span>
                                    </p>
                                }
                            </td>
                        </tr>
                    </table>
                </a>
            </li>
        }
    </ul>

    <div id="geolocation" style="display:none;padding:10px;">正在定位中....</div>
    <div id="shade" style="text-align:center;display:none">
        <img src="~/Content/images/loading.gif" />正在加载中...
    </div>
    @RenderPage("/Views/Shared/_Footer.cshtml")

</div>

<script>
    var KPC = KPC || {};
    KPC.AroundList = {};
    @*KPC.AroundList.UserGuid = "@ViewBag.UserGuid";*@
</script>

@if (ViewBag.UserTrack != null)
{
    @Scripts.Render("~/bundles/user/aroundlist")
    <script type="text/template" id="routelist_template">
        <% _.each(datas, function(item) { %>
        <li>
            <% var flag = "@(HttpContext.Current.Request.UrlReferrer == null ? "#flag" : "")"%>
            <a onclick="if (IsShowWait) showWait();" href="/user/viewprofile/<%= item.User.UserGUID %><%= flag %>" style="display:block">
                <table style="width:100%;">
                    <tr>
                        <td style="width:50px;">
                            <img class="showPortrait" src="<%= item.User.PortraitsThumbUrl === null ? '/Content/portraits/default.gif': item.User.PortraitsThumbUrl %>" />
                            <span style="font-size:14px;margin-right:5px;vertical-align:middle;display:block;text-align:center;"><%= item.User.UserRole === 1 ? "车主":"乘客" %></span>
                        </td>
                        <td>
                            <table width="100%" style="table-layout:fixed;">
                                <tr style="height:28px;color:gray;font-size:14px;line-height:28px;">
                                    <td>
                                        <span style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;width:50px;vertical-align:middle;"><%= item.User.NickName %></span>
                                        <span style="vertical-align:middle;"><%= item.Distance < 1 ? parseInt(item.Distance * 1000) + 'm' : item.Distance.toString().substring(0,item.Distance.toString().indexOf('.') + 2) + 'km' %></span>
                                    </td>
                                    <td style="text-align:right;">
                                        <% if(item.Route !== null){ %>

                                        <% switch(item.Route.RouteType) { case 17: %>
                                        <% var len = item.Route.StartDate.length, datestring = item.Route.StartDate.substring(6, len-2); dateobj =new Date(parseInt(datestring)); %>
                                        工作日
                                        <%= dateobj.getHours() < 10 ? '0' + dateobj.getHours() : dateobj.getHours() %>:<%= dateobj.getMinutes() < 10 ? '0' + dateobj.getMinutes() : dateobj.getMinutes() %>
                                        出发
                                        <% break; case 18: %>
                                        <% var len = item.Route.StartDate.length, datestring = item.Route.StartDate.substring(6, len-2); dateobj =new Date(parseInt(datestring)); %>
                                        周末
                                        <%= dateobj.getHours() < 10 ? '0' + dateobj.getHours() : dateobj.getHours() %>:<%= dateobj.getMinutes() < 10 ? '0' + dateobj.getMinutes() : dateobj.getMinutes() %>
                                        出发
                                        <% break; case 20: %>
                                        <% var len = item.Route.StartDate.length, datestring = item.Route.StartDate.substring(6, len-2); dateobj =new Date(parseInt(datestring)); %>
                                        <%= dateobj.getMonth() + 1 < 10 ? '0' + (dateobj.getMonth() + 1) : dateobj.getMonth() + 1 %>月<%= dateobj.getDate() < 10 ? '0' + dateobj.getDate() : dateobj.getDate() %>日

                                        <%= dateobj.getHours() < 10 ? '0' + dateobj.getHours() : dateobj.getHours() %>:<%= dateobj.getMinutes() < 10 ? '0' + dateobj.getMinutes() : dateobj.getMinutes() %>
                                        出发
                                        <% break; case 24: %>
                                        <% var len = item.Route.StartDate.length, datestring = item.Route.StartDate.substring(6, len-2); dateobj =new Date(parseInt(datestring)); %>
                                        每天
                                        <%= dateobj.getHours() < 10 ? '0' + dateobj.getHours() : dateobj.getHours() %>:<%= dateobj.getMinutes() < 10 ? '0' + dateobj.getMinutes() : dateobj.getMinutes() %>
                                        出发
                                        <% break; case 33: %>
                                        工作日 有效
                                        <% break; case 34: %>
                                        周末 有效
                                        <% break; case 36: %>
                                        <% var len = item.Route.StartDate.length, datestring = item.Route.StartDate.substring(6, len-2); dateobj =new Date(parseInt(datestring)); %>
                                        <%= dateobj.getMonth() + 1 < 10 ? '0' + (dateobj.getMonth() + 1) : dateobj.getMonth() + 1 %>月<%= dateobj.getDate() < 10 ? '0' + dateobj.getDate() : dateobj.getDate() %>日
                                        出发
                                        <% break;  case 40: %>
                                        长期有效
                                        <% break; default: break;%>
                                        <% }%>

                                        <% } %>
                                    </td>
                                </tr>
                            </table>
                            <% if(item.Route !== null){ %>
                            <p style="height:28px; line-height:28px;">
                                <span style="float: left; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;width:50%;"><%= item.Route.From_City === item.Route.To_City ? item.Route.From_District : item.Route.From_City %><%= item.Route.From_Location %></span>
                                <span style="float: right;text-align:right; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;width:50%;"><%= item.Route.From_City === item.Route.To_City ? item.Route.To_District : item.Route.To_City %><%= item.Route.To_Location %></span>
                            </p>
                            <% } %>
                        </td>
                    </tr>
                </table>
            </a>
        </li>
        <% }); %>
    </script>
}
else
{
    <div id="mapdiv" style="display:none"></div>
    <script>
        document.getElementById("geolocation").style.display = "block";
    </script>
    @Scripts.Render("~/bundles/user/aroundlistlocation")
}