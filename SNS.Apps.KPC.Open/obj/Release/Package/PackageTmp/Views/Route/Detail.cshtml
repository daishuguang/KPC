@model SNS.Apps.KPC.Libs.Models.UserRouteResult
@using SNS.Apps.KPC.Libs.Models
@using SNS.Apps.KPC.Libs.Utils
@using SNS.Apps.KPC.Libs.Configurations

@{
    String start_date = null;
    switch (Model.Route.RouteType)
    {
        case RouteType.Citywide_Workday:
            start_date = Model.Route.StartDate.Value.ToString("工作日 HH:mm");
            break;
        case RouteType.Citywide_Weekend:
            start_date = Model.Route.StartDate.Value.ToString("周末 HH:mm");
            break;
        case RouteType.Citywide_Temp:
            start_date = Model.Route.StartDate.Value.ToString("MM月dd日 HH:mm");
            break;
        case RouteType.Citywide_EveryDay:
            start_date = Model.Route.StartDate.Value.ToString("每天 HH:mm");
            break;
        case RouteType.Intercity_Workday:
            start_date = "工作日 有效";
            break;
        case RouteType.Intercity_Weekend:
            start_date = "周末 有效";
            break;
        case RouteType.Intercity_Temp:
            start_date = Model.Route.StartDate.Value.ToString("MM月dd日");
            break;
        case RouteType.Intercity_EveryDay:
            start_date = "长期有效";
            break;
        default:
            break;
    }

    ViewBag.Title = "路线详情:" + (String.IsNullOrEmpty(Model.Route.From_Location) ? Model.Route.From_City : Model.Route.From_City + Model.Route.From_District) + (Model.Route.From_City == Model.Route.To_City ? Model.Route.From_Location : null) + "→" +
            (String.IsNullOrEmpty(Model.Route.To_Location) ? Model.Route.To_City : Model.Route.To_City + Model.Route.To_District) + (Model.Route.From_City == Model.Route.To_City ? Model.Route.To_Location : null) + "  " + start_date;
    Layout = "~/Views/Shared/_LayoutList.cshtml";
}

@section head{
    @Styles.Render("~/Content/route/regandedit")
    <style>
        .showIcon {
            width: 17px;
            height: 17px;
        }

        .showPortrait {
            width: 50px;
            height: 50px;
            vertical-align: middle;
        }

        .divider {
            height: 30px;
            line-height: 30px;
            font-weight: bold;
            font-size: 14px;
        }

        .linormal {
            height: 40px;
            line-height: 40px;
        }

        p {
            margin: 5px;
        }

        .menu2 {
            display: none;
        }

        .fgray {
            color: #999;
            /*rgb(153,153,153);*/
        }

        .share {
            font-size: 16px;
            padding: 8px 15px;
            color: #000000;
            background-color: #ffffff;
            background-image: linear-gradient(to top, #f5f5f5,#ffffff);
            box-shadow: 0 1px 2px 0 rgba(0,0,0,0.15);
            text-shadow: 0.5px 0.5px 1px #fff;
            border-radius: 3px;
            text-indent: 20px;
            border: 1px solid #d3d3d3;
        }
    </style>
}

<div id="wrapper">
    <div class="header">
        <script>
            var message = location.hash.indexOf("#flag") === -1 ? false : true;
            var refernull = null;
        </script>
        @{
            ViewBag.ShowBackIcon = (HttpContext.Current.Request.UrlReferrer == null ? false : true);
        }

        <span id="backbtn" class="backbtn">
        </span>
        @if (!ViewBag.ShowBackIcon)
        {
            <script>
                refernull = true;
            </script>
        }
        <div class="headertitle">我的路线详情</div>
		@if (HttpContext.Current.User.Identity.IsAuthenticated && ViewBag.IsRouteOwner)
		{ 
			<span id="menu" style="position: absolute; top: 0px; right: 0px; padding: 0px 10px; height: 35px; line-height: 35px; margin: 7px 10px; border-radius: 3px; background-color: darkgreen; border: 1px solid #2f8d13;">
				更多
			</span>
			<div id="menu2" class="menu2" style="z-index:10;background-color:green;color:white;text-align:center;width:100px; position:absolute;top:40px;right:0px;">
				<a onclick="showWait();" href="/route/edit/@Model.Route.RouteGUID" style="color:white;display:block;">编辑</a>
				<a id="btnDel" style="display:block;">删除</a>
			</div>
		}
		else
		{
			<span style="position: absolute; top: 0px; right: 0px; padding: 0px 10px; height: 35px; line-height: 35px; margin: 7px 10px; border-radius: 3px; background-color: darkgreen; border: 1px solid #2f8d13;">
				<a class="phone" onclick="showWait();" href="/user/login?returnurl=/user/signin?returnurl=/route/detail/@Model.Route.RouteGUID" style="display:block;text-decoration:none;">
					登录
				</a>
			</span>
		}
    </div><!-- navbar -->
    <ul>
        <li style="border:none;">
            <table style="margin-top:5px;/*background: gainsboro;*/background-color:white;box-shadow:0 1px 2px rgba(0,0,0,0.3);" cellspacing="0" width="100%">
                <tr style="text-align:center;">
                    <td width="38%">
                        <span style="line-height:25px;font-weight:bold;">@(Model.Route.From_Location == null ? Model.Route.From_City : Model.Route.From_City + Model.Route.From_District)</span>
                        <div style="line-height: 25px; font-size: 14px;">
                            @Model.Route.From_Location
                        </div>
                    </td>
                    <td width="24%" style="font-size: 13px;color: #797979;">
                        @switch (Model.Route.RouteType)
                        {
                            case RouteType.Citywide_Workday:
                                @(Model.Route.StartDate.Value.ToString("工作日 HH:mm"));
                                break;
                            case RouteType.Citywide_Weekend:
                            @(Model.Route.StartDate.Value.ToString("周末 HH:mm"));
                            break;
                            case RouteType.Citywide_Temp:
                            @(Model.Route.StartDate.Value.ToString("MM月dd日 HH:mm"));
                            break;
                            case RouteType.Citywide_EveryDay:
                            @(Model.Route.StartDate.Value.ToString("每天 HH:mm"));
                            break;
                            case RouteType.Intercity_Workday:
                            @("工作日 有效");
                            break;
                            case RouteType.Intercity_Weekend:
                            @("周末 有效");
                            break;
                            case RouteType.Intercity_Temp:
                            @(Model.Route.StartDate.Value.ToString("MM月dd日"));
                            break;
                            case RouteType.Intercity_EveryDay:
                            @("长期有效");
                            break;
                            default:
                            break;
                        }
                    </td>
                    <td width="38%">
                        <span style="line-height:25px; font-weight:bold;">
                            @(Model.Route.To_Location == null ? Model.Route.To_City : Model.Route.To_City + Model.Route.To_District)
                        </span>
                        <div style="line-height: 25px; font-size: 14px;">
                            @Model.Route.To_Location
                        </div>
                    </td>
                </tr>
            </table>
            @if (Model.UserRole == UserRole.Driver)
            {
                <p>
                    @if (Model.Route.SeatCount.HasValue)
                    {
                        <span class="fgray">座位：</span>
                        @Model.Route.SeatCount
                        <span>&nbsp;座</span>
                    }
                    @if (Model.Route.Charge.HasValue)
                    {
                        <span style="float:right">
                            <span class="fgray">费用：</span>
                            @Model.Route.Charge.Value.ToString("#")
                            &nbsp;元/人
                        </span>
                    }
                </p>
            }
            <p><span class="fgray">备注：</span>@(Model.Route.Note == null ? "联系我时，请说是在微信\"快拼车\"上看到的，谢谢！" : Model.Route.Note + ";联系我时,请说是在微信\"快拼车\"上看到的,谢谢！")</p>
        </li>
    </ul>

	@if (ViewBag.IsWeChatBrowser)
	{ 
		<table style="table-layout:fixed;text-align:center;width:100%;margin:0px 0px;background-color:#fafafa;">
			<tr>
				<td>
					<input onclick="document.getElementById('mcover').style.display = 'block';" type="button" style="flex:1;background:url(/content/images/icon_msg.png) 5px 50% no-repeat;background-size:22px 22px;" class="share" value="发送给朋友" />
				</td>
				<td>
					<input onclick="document.getElementById('mcover').style.display = 'block';" type="button" style="flex:1;background:url(/content/images/icon_timeline.png) 5px 50% no-repeat;background-size:22px 22px;" class="share" value="分享到朋友圈" />
				</td>
			</tr>
		</table>
	}
	
    <div onclick="this.style.display = 'none';" id="mcover" style="display:none;z-index:1000;width:100%;height:100%;position:fixed;left:0;top:0;background:rgba(0,0,0,0.7);">
        <img src="/content/images/guide.png" style="position:fixed;top:5px;right:0px;" width="260" height="180" />
    </div>
    @if (@Model.Route.Status == RouteStatus.Available)
    {
        <ul id="content">
            <li id="listOrders" class="divider" style="border:none">我的拼单</li>
            @if (@ViewBag.RouteOrders != null && @ViewBag.RouteOrders.Length > 0)
            {
                foreach (UserOrderResult item in ViewBag.RouteOrders)
                {
                    <li onclick="showWait();window.location.href = '/order/detail/@item.Folio#mp.weixin.qq.com'">
                        <table style="width:100%;" cellpadding="0" cellspacing="0" border="0">
                            <tr>
                                <td style="width:50px;">
                                    <img class="showPortrait" src="@(!string.IsNullOrEmpty(item.Requestor.PortraitsThumbUrl) ? item.Requestor.PortraitsThumbUrl : ConfigStore.CommonSettings.Portraits_ImageDefault)" />
                                </td>
                                <td>
                                    <table style="width:100%;">
                                        <tr style="height:30px;">
                                            <td>
                                                <span>
                                                    @(!string.IsNullOrEmpty(item.Route.From_Location) ? (item.Route.From_City + item.Route.From_District) : (item.Route.From_City))
                                                </span>
                                                <span style="float: right">
                                                    @(!string.IsNullOrEmpty(item.Route.To_Location) ? (item.Route.To_City + item.Route.To_District) : (item.Route.To_City))
                                                </span>
                                            </td>
                                        </tr>
                                        <tr style="height: 30px; font-size: 14px; color: gray">
                                            <td>
                                                <span>
                                                    @switch (item.Route.RouteType)
                                                    {
                                                        case RouteType.Citywide_Workday:
                                                            @(item.Route.StartDate.Value.ToString("工作日 HH:mm 出发"));
                                                            break;
                                                        case RouteType.Citywide_Weekend:
                                                        @(item.Route.StartDate.Value.ToString("周末 HH:mm 出发"));
                                                        break;
                                                        case RouteType.Citywide_Temp:
                                                        @(item.Route.StartDate.Value.ToString("MM月dd日 HH:mm 出发"));
                                                        break;
                                                        case RouteType.Citywide_EveryDay:
                                                        @(item.Route.StartDate.Value.ToString("每天 HH:mm 出发"));
                                                        break;
                                                        case RouteType.Intercity_Workday:
                                                        @("工作日 有效");
                                                        break;
                                                        case RouteType.Intercity_Weekend:
                                                        @("周末 有效");
                                                        break;
                                                        case RouteType.Intercity_Temp:
                                                        @(item.Route.StartDate.Value.ToString("MM月dd日 出发"));
                                                        break;
                                                        case RouteType.Intercity_EveryDay:
                                                        @("长期有效");
                                                        break;
                                                        default:
                                                        break;
                                                    }
                                                </span>
                                                <span style="float:right">@(((OrderStatus)item.Status).GetDescription())</span>
                                            </td>
                                        </tr>
                                    </table>
                                </td>
                            </tr>
                        </table>
                    </li>
                }
            }
            else
            {
                <li class='linormal'>亲，现在还没有关联的拼单哟~</li>
            }

            <li id="listMatrixs" class="divider" style="border:none;">系统推荐</li>
            @if (ViewBag.RouteMatches != null && ViewBag.RouteMatches.Length > 0)
            {
                foreach (RouteSearchResult item in ViewBag.RouteMatches)
                {
                    <li style="padding:0px;" onclick="showWait();window.location.href = '/route/view?id=@item.Route.RouteGUID&from_lng=@Model.Route.From_Point.Longitude&from_lat=@Model.Route.From_Point.Latitude&to_lng=@Model.Route.To_Point.Longitude&to_lat=@Model.Route.To_Point.Latitude#mp.weixin.qq.com'">
                        <table style="width:100%;">
                            <tr>
                                <td style="width:50px;">
                                    <img class="showPortrait" src="@(!string.IsNullOrEmpty(item.User.PortraitsThumbUrl) ? item.User.PortraitsThumbUrl : ConfigStore.CommonSettings.Portraits_ImageDefault)" />
                                </td>
                                <td>
                                    <table style="width:100%;" border="0" cellpadding="0" cellspacing="0">
                                        <tr style="height:30px;">
                                            <td>
                                                @*@(String.IsNullOrEmpty(item.Route.From_Location) ? item.Route.From_City : item.Route.From_City + item.Route.From_District)
                                                    <span style="float:right">
                                                        @(String.IsNullOrEmpty(item.Route.To_Location) ? item.Route.To_City : item.Route.To_City + item.Route.To_District)
                                                    </span>*@

                                                <div>
                                                    @(String.IsNullOrEmpty(item.Route.From_Location) ? item.Route.From_City : item.Route.From_City + item.Route.From_District)
                                                    →
                                                    <span style="float: right;width:45%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                                        @(String.IsNullOrEmpty(item.Route.To_Location) ? item.Route.To_City : item.Route.To_City + item.Route.To_District)
                                                    </span>
                                                </div>
                                                <div style="line-height: 30px; font-size: 14px; color: gray;">
                                                    <span style="float:left;max-width:120px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">
                                                        @(item.Route.From_City == item.Route.To_City ? item.Route.From_Location : null)
                                                    </span>
                                                    <span style="float:right;width:45%;white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                                        @(item.Route.From_City == item.Route.To_City ? item.Route.To_Location : null)
                                                    </span>
                                                </div>
                                            </td>
                                        </tr>
                                    </table>
                                </td>
                            </tr>
                            <tr style="height: 30px; font-size: 14px; color: gray">
                                <td style="text-align:center;">
                                    @(item.UserRole == UserRole.Driver ? "车主" : "乘客")
                                </td>
                                <td>
                                    <div style="float:left;line-height:30px;">
                                        @switch (item.Route.RouteType)
                                        {
                                            case RouteType.Citywide_Workday:
                                                @(item.Route.StartDate.Value.ToString("工作日 HH:mm 出发"));
                                                break;
                                            case RouteType.Citywide_Weekend:
                                            @(item.Route.StartDate.Value.ToString("周末 HH:mm 出发"));
                                            break;
                                            case RouteType.Citywide_Temp:
                                            @(item.Route.StartDate.Value.ToString("MM月dd日 HH:mm 出发"));
                                            break;
                                            case RouteType.Citywide_EveryDay:
                                            @(item.Route.StartDate.Value.ToString("每天 HH:mm 出发"));
                                            break;
                                            case RouteType.Intercity_Workday:
                                            @("工作日 有效");
                                            break;
                                            case RouteType.Intercity_Weekend:
                                            @("周末 有效");
                                            break;
                                            case RouteType.Intercity_Temp:
                                            @(item.Route.StartDate.Value.ToString("MM月dd日 出发"));
                                            break;
                                            case RouteType.Intercity_EveryDay:
                                            @("长期有效");
                                            break;
                                            default:
                                            break;
                                        }
                                    </div>
                                    <div style="text-align:left;float:right; width:45%;">
                                        @if (item.UserRole == UserRole.Driver)
                                        {
                                            <h4 style="line-height:30px;">@(item.Route.Charge.HasValue ? item.Route.Charge.Value.ToString("#") + " 元/人" : "价格面议")</h4>
                                        }
                                    </div>
                                </td>
                            </tr>
                        </table>
                    </li>
                }
            }
            else
            {
                <li class='linormal'>亲，还未找到和您匹配的路线, 记得常回来看看哟~</li>
            }
        </ul>
    }
    @RenderPage("/Views/Shared/_Footer.cshtml")

</div>

<script>
    (function () {
        document.getElementById("backbtn").addEventListener("click", function () {
            if (refernull) {
                if (message) {
                    WeixinJSBridge.call("closeWindow");
                } else {
                    WeixinJSBridge.call("closeWindow");
                    window.location.href = "/route/list";
                }
            } else {
                history.back();
            }
        });
    })();
</script>
@if (@Model.Route.Status == RouteStatus.Available)
{
    <script type="text/javascript">
        var _userID = "@Model.User.UserGUID";
        var _routeID = "@Model.Route.RouteGUID";
    </script>

    @Scripts.Render("~/bundles/route/detail");
}