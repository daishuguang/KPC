@model IEnumerable<SNS.Apps.KPC.Libs.Models.UserRouteResult>
@using SNS.Apps.KPC.Libs.Models
@using SNS.Apps.KPC.Libs.Utils
@using SNS.Apps.KPC.Libs.Configurations

@{
    Layout = "~/Views/Shared/_LayoutList.cshtml";
    if (HttpContext.Current.Request.UserAgent.Contains("kuaipinche"))
    {
        ViewBag.Title = "最新路线";
    }
    else
    {
        ViewBag.Title = "快拼车";
    }
}

@section head{
    @Styles.Render("~/Content/route/listview")
    <style>
        .rightarrow {
            width: 0px;
            height: 0px;
            line-height: 40px;
            right: 5px;
            position: absolute;
            text-align: center;
            color: white;
            border: 5px solid white;
            border-left-color: rgba(0,0,0,0);
            border-right-color: rgba(0,0,0,0);
            border-bottom-color: rgba(0,0,0,0);
            top: 50%;
        }

        #searchresult li:nth-child(2n+1) {
            background-color: white;
        }

        ul#searchresult li a {
            padding: 0 5px;
        }

        ul#searchresult li:hover, ul#searchresult li:active {
            background-color: #d5d5d5;
            /*background-color: #efefef;*/
        }

        h4 {
            line-height: 20px;
        }
    </style>
    <script>
        var IsShowWait = false;
        if (location.hash.indexOf('#w') === -1) {
            // 不是从微信消息进来的
            IsShowWait = true;
        }
    </script>
}

@RenderPage("/Views/Shared/_Navbar.cshtml")
<div id="wrapper">
    <div class="header" style="@(HttpContext.Current.Request.UserAgent.Contains("kuaipinche") ?"display:none":"")">
        <span id="navbar" class="headermenu"></span>
        <div class="headertitle">最新路线</div>
        <a href="/route/city" onclick="javascript:showWait();" style="color:white;position: absolute;text-align:center;top:0px; right: 0px; width: 100px;" id="category">@(String.IsNullOrEmpty(ViewBag.City) ? "全国" : ViewBag.City)</a>
        <div class="rightarrow"></div>
    </div>
    <ul id="searchresult">
        @foreach (var item in Model)
        {
            <li>
                <a onclick="if (IsShowWait) showWait();" href="/route/view/@item.Route.RouteGUID#mp.weixin.qq.com@(HttpContext.Current.Request.UrlReferrer == null ? "#flag" : "")" style="display:block">
                    <table style="width: 100%;" cellspacing="0">
                        <tr>
                            <td style="width:50px;">
                                <img width="50" height="50" style="vertical-align:middle;" src="@(!string.IsNullOrEmpty(item.User.PortraitsThumbUrl) ? item.User.PortraitsThumbUrl : ConfigStore.CommonSettings.Portraits_ImageDefault)" />
                            </td>
                            <td>
                                <table style="width:100%;" border="0" cellpadding="0" cellspacing="0">
                                    <tr style="height:30px;">
                                        <td>
                                            <div>
                                                @*@(String.IsNullOrEmpty(item.Route.From_Location) ? item.Route.From_City : item.Route.From_City + item.Route.From_District)*@
                                                @(item.Route.From_City == item.Route.To_City ? item.Route.From_District : item.Route.From_City)
                                                →
                                                <span style="float: right;width:45%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                                    @*@(String.IsNullOrEmpty(item.Route.To_Location) ? item.Route.To_City : item.Route.To_City + item.Route.To_District)*@
                                                    @(item.Route.From_City == item.Route.To_City ? item.Route.To_District : item.Route.To_City)
                                                </span>
                                            </div>
                                            <div style="line-height:30px;font-size: 14px;color:gray;">
                                                <span style="float:left;max-width:120px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">
                                                    @*@(item.Route.From_City == item.Route.To_City ? item.Route.From_Location : null)*@
                                                    @(item.Route.From_Location)
                                                </span>
                                                <span style="float:right;width:45%;white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                                    @*@(item.Route.From_City == item.Route.To_City ? item.Route.To_Location : null)*@
                                                    @(item.Route.To_Location)
                                                </span>
                                            </div>

                                        </td>
                                    </tr>
                                </table>
                            </td>
                        </tr>
                        <tr style="height: 30px; font-size: 14px; color: gray">
                            @*<td>
                                    <h4 style="font-weight:normal;">@(item.Route.RouteType == RouteType.Intercity_LongDistance || item.Route.RouteType == RouteType.Intercity_ShortDistance ? (item.Route.IsLongTerm != null && item.Route.IsLongTerm.HasValue && item.Route.IsLongTerm.Value ? "长期有效" : item.Route.StartDate.Value.ToString("MM月dd日 出发")) : item.Route.StartDate.Value.ToString("每天 HH:mm 出发"))</h4>
                                    <h4 style="font-weight:normal;">@(((UserRole)item.UserRole).GetDescription())</h4>
                                </td>
                                <td style="text-align:left;">
                                    @if (item.UserRole == UserRole.Driver)
                                    {
                                        <h4>@(item.Route.Charge.HasValue ? item.Route.Charge.Value.ToString("#") + " 元/人" : "面议")</h4>
                                        <h4>@(item.Route.SeatCount.HasValue ? item.Route.SeatCount + " 座" : "")</h4>
                                    }
                                </td>*@
                            <td style="text-align:center;">
                                @(((UserRole)item.UserRole).GetDescription())
                            </td>
                            <td>
                                <div style="float:left;line-height:30px;">
                                    @switch (item.Route.RouteType)
                                    {
                                        case RouteType.Citywide_Workday:
                                            @(item.Route.StartDate.Value.ToString("工作日 HH:mm 出发"));
                                            break;
                                        case RouteType.Citywide_Weekend:
                                        @(item.Route.StartDate.Value.ToString("周末 HH:mm 出发"));
                                        break;
                                        case RouteType.Citywide_Temp:
                                        @(item.Route.StartDate.Value.ToString("MM月dd日 HH:mm 出发"));
                                        break;
                                        case RouteType.Citywide_EveryDay:
                                        @(item.Route.StartDate.Value.ToString("每天 HH:mm 出发"));
                                        break;
                                        case RouteType.Intercity_Workday:
                                        @("工作日 有效");
                                        break;
                                        case RouteType.Intercity_Weekend:
                                        @("周末 有效");
                                        break;
                                        case RouteType.Intercity_Temp:
                                        @(item.Route.StartDate.Value.ToString("MM月dd日 出发"));
                                        break;
                                        case RouteType.Intercity_EveryDay:
                                        @("长期有效");
                                        break;
                                        default:
                                        break;
                                    }
                                </div>
                                <div style="text-align:left;float:right; width:45%;">
                                    @if (item.UserRole == UserRole.Driver)
                                    {
                                        <h4 style="line-height: 30px;">@(item.Route.Charge.HasValue ? item.Route.Charge.Value.ToString("N0") + " 元/人" : "价格面议")</h4>
                                    }
                                </div>
                            </td>
                        </tr>
                    </table>
                </a>

            </li>
        }
    </ul>
    <div id="shade" style="text-align:center;display:none">
        <img src="~/Content/images/loading.gif" />正在加载中...
    </div>
    @RenderPage("/Views/Shared/_Footer.cshtml")

</div>

<script type="text/javascript">
    var _city = "@ViewBag.City";
</script>

@Scripts.Render("~/bundles/route/plaza")

<script type="text/template" id="routelist_template">
    <% _.each(datas, function(item) { %>
    <li>
        <% var flag = "@(HttpContext.Current.Request.UrlReferrer == null ? "#flag" : "")"%>
        <a href="/route/view/<%= item.Route.RouteGUID %>#mp.weixin.qq.com<%= flag %>" onclick="if (IsShowWait) showWait();" style="display:block">
            <table style="width:100%;">
                <tr>
                    <td style="width:50px;">
                        <img width="50" height="50" style="vertical-align:middle;" src="<%= item.User.PortraitsThumbUrl === null ? '/Content/portraits/default.jpg': item.User.PortraitsThumbUrl %>" />
                    </td>
                    <td>
                        <table style="width:100%;" border="0" cellpadding="0" cellspacing="0">
                            <tr style="height:30px;">
                                <td>
                                    <div>
                                        @*<%= item.Route.From_Location === null ? item.Route.From_City : item.Route.From_City + item.Route.From_District %>*@
                                        <%= item.Route.From_City === item.Route.To_City ? item.Route.From_District : item.Route.From_City %>
                                        →
                                        <span style="float: right;width:45%;">
                                            @*<%= item.Route.To_Location===null ? item.Route.To_City : item.Route.To_City + item.Route.To_District %>*@
                                            <%= item.Route.From_City === item.Route.To_City ? item.Route.To_District : item.Route.To_City %>
                                        </span>
                                    </div>
                                    <div style="line-height: 30px;font-size: 14px;color:gray;">
                                        <span style="float:left;max-width:120px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">
                                            @*<%= (item.Route.From_City === item.Route.To_City ? item.Route.From_Location:null) %>*@
                                            <%= item.Route.From_Location %>
                                        </span>
                                        <span style="width: 45%; text-align: left; float: right; /*max-width:120px;*/ white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                            @*<%= (item.Route.From_City === item.Route.To_City ? item.Route.To_Location : null) %>*@
                                            <%= item.Route.To_Location %>
                                        </span>
                                    </div>
                                </td>
                            </tr>
                        </table>
                    </td>
                </tr>
                <tr style="height: 30px; font-size: 14px; color: gray">
                    <td style="text-align:center">
                        <%= item.UserRole === 1 ? "车主":"乘客" %>
                    </td>
                    <td>
                        <div style="float:left;line-height:30px;">
                            <% switch(item.Route.RouteType) { case 17: %>
                            <% var len = item.Route.StartDate.length, datestring = item.Route.StartDate.substring(6, len-2); dateobj =new Date(parseInt(datestring)); %>
                            工作日
                            <%= dateobj.getHours() < 10 ? '0' + dateobj.getHours() : dateobj.getHours() %>:<%= dateobj.getMinutes() < 10 ? '0' + dateobj.getMinutes() : dateobj.getMinutes() %>
                            出发
                            <% break; case 18: %>
                            <% var len = item.Route.StartDate.length, datestring = item.Route.StartDate.substring(6, len-2); dateobj =new Date(parseInt(datestring)); %>
                            周末
                            <%= dateobj.getHours() < 10 ? '0' + dateobj.getHours() : dateobj.getHours() %>:<%= dateobj.getMinutes() < 10 ? '0' + dateobj.getMinutes() : dateobj.getMinutes() %>
                            出发
                            <% break; case 20: %>
                            <% var len = item.Route.StartDate.length, datestring = item.Route.StartDate.substring(6, len-2); dateobj =new Date(parseInt(datestring)); %>
                            <%= dateobj.getMonth() + 1 < 10 ? '0' + (dateobj.getMonth() + 1) : dateobj.getMonth() + 1 %>月<%= dateobj.getDate() < 10 ? '0' + dateobj.getDate() : dateobj.getDate() %>日

                            <%= dateobj.getHours() < 10 ? '0' + dateobj.getHours() : dateobj.getHours() %>:<%= dateobj.getMinutes() < 10 ? '0' + dateobj.getMinutes() : dateobj.getMinutes() %>
                            出发
                            <% break; case 24: %>
                            <% var len = item.Route.StartDate.length, datestring = item.Route.StartDate.substring(6, len-2); dateobj =new Date(parseInt(datestring)); %>
                            每天
                            <%= dateobj.getHours() < 10 ? '0' + dateobj.getHours() : dateobj.getHours() %>:<%= dateobj.getMinutes() < 10 ? '0' + dateobj.getMinutes() : dateobj.getMinutes() %>
                            出发
                            <% break; case 33: %>
                            工作日 有效
                            <% break; case 34: %>
                            周末 有效
                            <% break; case 36: %>
                            <% var len = item.Route.StartDate.length, datestring = item.Route.StartDate.substring(6, len-2); dateobj =new Date(parseInt(datestring)); %>
                            <%= dateobj.getMonth() + 1 < 10 ? '0' + (dateobj.getMonth() + 1) : dateobj.getMonth() + 1 %>月<%= dateobj.getDate() < 10 ? '0' + dateobj.getDate() : dateobj.getDate() %>日
                            出发
                            <% break;  case 40: %>
                            长期有效
                            <% break; default: break;%>
                            <% }%>

                        </div>
                        <div style="float:right;width:45%;">
                            <% if(item.UserRole === 1) {%>
                            <h4 style="line-height: 30px;"><%= item.Route.Charge !== null ? item.Route.Charge + " 元/人" : "价格面议" %></h4>
                            <% } %>
                        </div>
                </tr>
            </table>
        </a>
    </li>
    <% }); %>
</script>